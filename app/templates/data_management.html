<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Management</title>
    <style>
      :root {
        --bg: #ffffff;
        --ink: #000000;
        --muted: #222222;
        --border: #000000;
        --shadow: rgba(0, 0, 0, 0.08);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Georgia", "Times New Roman", serif;
        color: var(--ink);
        background-color: var(--bg);
        background-image:
          linear-gradient(0deg, rgba(0, 0, 0, 0.04) 1px, transparent 1px),
          linear-gradient(90deg, rgba(0, 0, 0, 0.04) 1px, transparent 1px);
        background-size: 24px 24px;
      }

      main {
        max-width: 980px;
        margin: 0 auto;
        padding: 32px 20px 64px;
        animation: fadeIn 0.35s ease-out;
      }

      .nav {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        padding: 12px;
        border: 2px solid var(--border);
        background: #ffffff;
        box-shadow: 6px 6px 0 var(--border);
      }

      .nav a {
        text-decoration: none;
        color: var(--ink);
        border: 2px solid var(--border);
        padding: 6px 12px;
        font-weight: 700;
        letter-spacing: 0.3px;
      }

      .nav a.active {
        background: var(--ink);
        color: #ffffff;
      }

      header {
        margin-top: 24px;
      }

      header h1 {
        font-size: 32px;
        margin: 0 0 8px;
      }

      header p {
        margin: 0;
        color: var(--muted);
      }

      .panel {
        margin-top: 24px;
        border: 2px solid var(--border);
        padding: 16px;
        background: #ffffff;
        box-shadow: 8px 8px 0 var(--border);
      }

      form {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }

      input[type="file"] {
        border: 2px solid var(--border);
        padding: 8px;
        background: #ffffff;
        color: var(--ink);
      }

      button {
        border: 2px solid var(--border);
        background: var(--ink);
        color: #ffffff;
        padding: 8px 14px;
        font-weight: 700;
        cursor: pointer;
      }

      button.secondary {
        background: #ffffff;
        color: var(--ink);
      }

      button[disabled] {
        opacity: 0.7;
        cursor: not-allowed;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
        font-size: 15px;
      }

      th,
      td {
        border: 2px solid var(--border);
        padding: 10px;
        text-align: left;
        vertical-align: top;
      }

      th {
        background: var(--ink);
        color: #ffffff;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .hidden-input {
        display: none;
      }

      .status {
        margin-top: 12px;
        min-height: 20px;
        font-weight: 600;
      }

      .status[data-state="error"] {
        color: #000000;
        text-decoration: underline;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 720px) {
        table,
        thead,
        tbody,
        th,
        td,
        tr {
          display: block;
        }

        thead {
          display: none;
        }

        tr {
          margin-bottom: 16px;
        }

        td {
          border-top: none;
        }

        td::before {
          content: attr(data-label);
          display: block;
          font-weight: 700;
          margin-bottom: 4px;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        main {
          animation: none;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <nav class="nav" aria-label="Primary">
        <a href="/chat">Chat</a>
        <a class="active" href="/data-management">Data Management</a>
        <a href="/settings">Settings</a>
      </nav>

      <header>
        <h1>Data Management</h1>
        <p>Upload, replace, and remove documents for retrieval.</p>
      </header>

      <section class="panel">
        <form id="uploadForm">
          <input id="fileInput" type="file" multiple accept=".pdf,.docx,.txt" />
          <button type="submit" id="uploadBtn">Upload & Index</button>
        </form>
        <div class="status" id="uploadStatus" data-state="ok">Ready to upload.</div>
      </section>

      <section class="panel">
        <div class="actions" style="justify-content: space-between; align-items: center;">
          <h2 style="margin: 0;">Indexed Files</h2>
          <button class="secondary" id="refreshBtn" type="button">Refresh</button>
        </div>
        <table aria-live="polite">
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Size</th>
              <th>Chunks</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="filesTable"></tbody>
        </table>
        <div class="status" id="listStatus" data-state="ok"></div>
      </section>
    </main>

    <script>
      const uploadForm = document.getElementById("uploadForm");
      const fileInput = document.getElementById("fileInput");
      const uploadBtn = document.getElementById("uploadBtn");
      const uploadStatus = document.getElementById("uploadStatus");
      const refreshBtn = document.getElementById("refreshBtn");
      const filesTable = document.getElementById("filesTable");
      const listStatus = document.getElementById("listStatus");
      const progressSteps = [
        "Uploading file...",
        "Parsing document text...",
        "Chunking content...",
        "Embedding & indexing...",
        "Finalizing...",
      ];
      let progressTimer = null;
      let progressIndex = 0;

      function setStatus(el, text, isError = false) {
        el.textContent = text;
        el.dataset.state = isError ? "error" : "ok";
      }

      function setButtonLoading(button, isLoading, text) {
        if (!button.dataset.defaultText) {
          button.dataset.defaultText = button.textContent;
        }
        button.disabled = isLoading;
        if (isLoading && text) {
          button.textContent = text;
        }
        if (!isLoading) {
          button.textContent = button.dataset.defaultText;
        }
      }

      function bytesToSize(bytes) {
        if (bytes < 1024) return `${bytes} B`;
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
        return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
      }

      function startProgress() {
        stopProgress();
        progressIndex = 0;
        setStatus(uploadStatus, progressSteps[progressIndex]);
        progressTimer = setInterval(() => {
          if (progressIndex < progressSteps.length - 1) {
            progressIndex += 1;
            setStatus(uploadStatus, progressSteps[progressIndex]);
          }
        }, 5000);
      }

      function stopProgress() {
        if (progressTimer) {
          clearInterval(progressTimer);
          progressTimer = null;
        }
      }

      async function fetchFiles() {
        const res = await fetch("/api/files");
        if (!res.ok) throw new Error("Unable to load files");
        return res.json();
      }

      function buildRow(doc) {
        const tr = document.createElement("tr");
        const created = new Date(doc.created_at).toLocaleString();

        tr.innerHTML = `
          <td data-label="Name">${doc.original_name}</td>
          <td data-label="Type">${doc.file_type.toUpperCase()}</td>
          <td data-label="Size">${bytesToSize(doc.size_bytes)}</td>
          <td data-label="Chunks">${doc.chunk_count}</td>
          <td data-label="Created">${created}</td>
          <td data-label="Actions">
            <div class="actions">
              <button class="secondary" data-action="replace" data-id="${doc.id}">Replace</button>
              <button data-action="delete" data-id="${doc.id}">Delete</button>
              <input class="hidden-input" type="file" accept=".pdf,.docx,.txt" data-input="${doc.id}" />
            </div>
          </td>
        `;

        return tr;
      }

      async function renderFiles() {
        filesTable.innerHTML = "";
        setStatus(listStatus, "Loading documents...");

        try {
          const docs = await fetchFiles();
          if (!docs.length) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="6">No indexed files yet.</td>`;
            filesTable.appendChild(tr);
            setStatus(listStatus, "0 documents.");
            return;
          }

          docs.forEach((doc) => filesTable.appendChild(buildRow(doc)));
          setStatus(listStatus, `${docs.length} documents loaded.`);
        } catch (error) {
          setStatus(listStatus, error.message || "Unable to load documents.", true);
        }
      }

      async function uploadFiles(files) {
        const fd = new FormData();
        for (const file of files) fd.append("files", file);

        const res = await fetch("/api/files", { method: "POST", body: fd });
        const payload = await res.json();
        if (!res.ok) throw new Error(payload.detail || "Upload failed");
        return payload;
      }

      async function deleteFile(documentId) {
        const res = await fetch(`/api/files/${documentId}`, { method: "DELETE" });
        if (!res.ok) {
          const payload = await res.json();
          throw new Error(payload.detail || "Delete failed");
        }
      }

      async function replaceFile(documentId, file) {
        const fd = new FormData();
        fd.append("file", file);

        const res = await fetch(`/api/files/${documentId}`, { method: "PUT", body: fd });
        if (!res.ok) {
          const payload = await res.json();
          throw new Error(payload.detail || "Replace failed");
        }
      }

      uploadForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!fileInput.files?.length) {
          setStatus(uploadStatus, "Choose at least one file.", true);
          return;
        }

        uploadBtn.dataset.defaultText = uploadBtn.textContent;
        setButtonLoading(uploadBtn, true, "Uploading...");
        startProgress();

        try {
          const payload = await uploadFiles(fileInput.files);
          const indexed = payload.indexed?.length || 0;
          const failed = payload.failed?.length || 0;
          const failedItems = Array.isArray(payload.failed) ? payload.failed : [];
          if (failedItems.length) {
            const reasons = failedItems
              .map((item) => `${item.filename || "unknown"}: ${item.reason || "unknown error"}`)
              .join(" | ");
            setStatus(uploadStatus, `Indexed ${indexed}. Failed ${failed}. ${reasons}`, true);
          } else {
            setStatus(uploadStatus, `Indexed ${indexed}. Failed ${failed}.`);
          }
          fileInput.value = "";
          await renderFiles();
        } catch (error) {
          setStatus(uploadStatus, error.message || "Upload failed.", true);
        } finally {
          stopProgress();
          setButtonLoading(uploadBtn, false);
        }
      });

      refreshBtn.addEventListener("click", async () => {
        refreshBtn.dataset.defaultText = refreshBtn.textContent;
        setButtonLoading(refreshBtn, true, "Refreshing...");
        await renderFiles();
        setButtonLoading(refreshBtn, false);
      });

      filesTable.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLButtonElement)) return;

        const action = target.dataset.action;
        const id = target.dataset.id;
        if (!action || !id) return;

        if (action === "delete") {
          if (!window.confirm("Delete this document and its vectors?")) return;
          try {
            await deleteFile(id);
            await renderFiles();
          } catch (error) {
            setStatus(listStatus, error.message || "Delete failed.", true);
          }
        }

        if (action === "replace") {
          const input = document.querySelector(`input[data-input='${id}']`);
          if (!(input instanceof HTMLInputElement)) return;
          input.click();
          input.onchange = async () => {
            const file = input.files?.[0];
            if (!file) return;
            try {
              await replaceFile(id, file);
              await renderFiles();
            } catch (error) {
              setStatus(listStatus, error.message || "Replace failed.", true);
            } finally {
              input.value = "";
            }
          };
        }
      });

      renderFiles();
    </script>
  </body>
</html>
